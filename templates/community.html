{% include "layout.html" %}
{% set page = "community" %}

{% if status != "need_login" %}
<style>
  .sort-link .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    transition: all 0.2s;
    background-color: #f6f9ff;
  }

  .sort-link.active .dot {
    background-color: #4f46e5;
  }

  .sort-link.active {
    font-weight: 700;
    color: #4f46e5;
  }

  .pagination {
    margin-top: 20px;
    text-align: center;
  }

  .pagination-list {
    list-style: none;
    display: inline-flex;
    gap: 8px;
    padding: 0;
  }

  .page-item a {
    padding: 6px 12px;
    border: 1px solid #ddd;
    text-decoration: none;
    color: #333;
    border-radius: 4px;
  }

  .page-item.active a {
    background-color: #007bff;
    color: #fff;
    font-weight: bold;
  }
</style>
{% endif %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">

  {% if status == "need_login" %}
  <div class="flex justify-center">
    <div class="bg-white/90 p-6 rounded-2xl shadow-xl text-center"
      style="margin-top: 35px; width: 850px; max-width: 100%;">
      <h2 class="text-2xl font-bold text-slate-800 mb-4">로그인이 필요한 서비스입니다.</h2>
      <a href="/login">
        <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
          로그인 하러 가기
        </button>
      </a>
    </div>
  </div>

  {% else %}
  <main class="max-w-4xl mx-auto px-6 py-8">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-3xl font-bold text-slate-800 mb-2">음악 추천 게시판</h2>
        <p class="text-slate-600">다른 사용자들과 좋은 음악을 공유해보세요</p>
      </div>

      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-3 text-sm font-medium">
          <a href="/community?sort=latest"
            class="sort-link flex items-center text-slate-500 {{ 'active' if not sort_by or sort_by == 'latest' }}">
            <span class="dot mr-1.5"></span>최신순
          </a>
          <a href="/community?sort=similar"
            class="sort-link flex items-center text-slate-500 {{ 'active' if sort_by == 'similar' }}">
            <span class="dot mr-1.5"></span>나와 취향 비슷한 사람
          </a>
        </div>

        <a href="/write">
          <button
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
            글쓰기
          </button>
        </a>
      </div>
    </div>

    <div id="posts-container" class="space-y-4">
      {% if data and data.posts %}
      {% for post in data.posts %}
      <div class="post-card bg-white rounded-xl shadow p-4 flex items-stretch" data-post-id="{{ post._id }}">

        <!-- 앨범 이미지 -->
        <div class="flex-shrink-0 text-center w-36 pr-4 cursor-pointer"
          onclick="window.location.href='/post/{{ post._id }}'">
          <img src="{{ post.song_info.album_cover or 'https://placehold.co/150x150/E2E8F0/A0AEC0?text=No+Image' }}"
            alt="Album Cover" class="w-24 h-24 object-cover rounded-lg mx-auto">
          <h4 class="text-sm font-semibold text-slate-700 mt-2 line-clamp-2">{{ post.song_info.title }}</h4>
          <p class="text-xs text-slate-500 line-clamp-1">{{ post.song_info.artist }}</p>
        </div>

        <!-- 게시글 내용 -->
        <div class="flex-grow px-4 border-l border-r border-gray-200 cursor-pointer"
          onclick="window.location.href='/post/{{ post._id }}'">
          <h3 class="text-lg font-bold text-slate-800">{{ post.title }}</h3>
          <p class="text-sm text-gray-600 mt-2 break-all">{{ post.content }}</p>
        </div>

        <!-- 작성자 + 좋아요/댓글 -->
        <div class="flex flex-col items-end justify-between flex-shrink-0 pl-4 w-28">
          <div class="text-right">
            <p class="text-sm font-medium text-slate-700">{{ post.nickname }}</p>
            <p class="text-xs text-slate-500">{{ post.created_at }}</p>
          </div>
          <div class="flex items-center gap-4 mt-auto text-sm">

            <!-- 좋아요 -->
            <div class="flex items-center gap-1.5">
              <div class="bg-gradient-to-r opacity-80 from-indigo-500 to-purple-600 
                p-1 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                  class="w-3 h-3 text-white transform -translate-y-0.3.5">
                  <path d="M2 10h4v12H2V10zm20 1c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32
                 c0-.41-.17-.79-.44-1.06L13.17 2 7.59 7.59C7.22 7.95 7 8.45 
                 7 9v11c0 1.1.9 2 2 2h8c.83 0 1.54-.5 1.84-1.22l3.02-7.05
                 c.09-.23.14-.47.14-.73v-2z" />
                </svg>
              </div>
              <span>{{ post.likes }}</span>
            </div>

            <!-- 댓글 (💬 이모지) -->
            <div class="flex items-center gap-1.5 cursor-pointer"
              onclick="window.location.href='/post/{{ post._id }}#comments'">
              <span class="text-sm leading-none">💬</span>
              <span>{{ post.comment_count or 0 }}</span>
            </div>

          </div>

        </div>
      </div>
      {% endfor %}
      {% else %}
      <p class="text-center text-slate-500">표시할 게시글이 없습니다.</p>
      {% endif %}
    </div>

    <!-- 페이지네이션 -->
    <div class="pagination flex justify-center mt-6">
      {% if data and data.total_pages > 1 %}
      <ul class="flex gap-2">
        {% for p in range(1, data.total_pages + 1) %}
        <li>
          <a href="{{ url_for('community.community_page', page=p, sort_by=sort_by) }}" class="px-3 py-1 rounded-lg border
                                {% if p == data.current_page %}
                                    bg-indigo-600 text-white
                                {% else %}
                                    bg-white text-gray-800 hover:bg-gray-100
                                {% endif %}">
            {{ p }}
          </a>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
  </main>
  {% endif %}
</div>
{% endblock %}